name: Release

on:
  push:
    tags:
      - "v*"

env:
  HUSKY: 0

jobs:
  build:
    name: Build MTA Extensions
    runs-on: ubuntu-latest
    outputs:
      upstream_sha: ${{ steps.pull.outputs.upstream_sha }}
      upstream_sha_short: ${{ steps.pull.outputs.upstream_sha_short }}
      mta_version: ${{ steps.version.outputs.mta_version }}

    steps:
      - name: Checkout MTA build repo
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Strip 'v' prefix
          echo "mta_version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building MTA version: ${VERSION}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install MTA build dependencies
        run: npm install

      - name: Pull upstream and apply branding
        id: pull
        run: |
          npm run pull-upstream

          # Capture upstream SHA for provenance
          cd .upstream-workspace
          SHA=$(git rev-parse HEAD)
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "upstream_sha=${SHA}" >> $GITHUB_OUTPUT
          echo "upstream_sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Show build configuration
        run: |
          echo "## Release Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.mta_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream**: [\`${{ steps.pull.outputs.upstream_sha_short }}\`](https://github.com/konveyor/editor-extensions/commit/${{ steps.pull.outputs.upstream_sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### mta-build.yaml" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          cat mta-build.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Install upstream dependencies
        working-directory: .upstream-workspace
        run: npm ci

      - name: Collect runtime assets
        working-directory: .upstream-workspace
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use release artifacts from konveyor/editor-extensions
          npm run collect-assets -- --use-release

      - name: Build all workspaces
        working-directory: .upstream-workspace
        run: npm run build
        env:
          UPSTREAM_GIT_SHA: ${{ steps.pull.outputs.upstream_sha }}

      - name: Show transformed package.json files
        run: |
          echo "## Transformed package.json files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for ext in core java javascript go; do
            PKG=".upstream-workspace/vscode/${ext}/package.json"
            if [ -f "$PKG" ]; then
              echo "### vscode/${ext}/package.json" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              jq '{name, displayName, version, publisher, coreExtensionId, extensionDependencies}' "$PKG" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Create distribution
        working-directory: .upstream-workspace
        run: npm run dist

      - name: Package extensions
        working-directory: .upstream-workspace
        run: |
          npm run package-core
          npm run package-java
          npm run package-javascript
          # npm run package-go  # Enable when Go is ready

      - name: Show dist file tree
        run: |
          echo "## Distribution Contents" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh .upstream-workspace/dist/*.vsix >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No VSIX files found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload VSIX artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mta-vsix-${{ steps.version.outputs.mta_version }}
          path: .upstream-workspace/dist/*.vsix
          retention-days: 90

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Download VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          name: mta-vsix-${{ needs.build.outputs.mta_version }}
          path: ./dist

      - name: List artifacts
        run: ls -la ./dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/*.vsix
          name: MTA ${{ needs.build.outputs.mta_version }}
          body: |
            ## Migration Toolkit for Applications ${{ needs.build.outputs.mta_version }}

            ### Build Information
            - **Built from**: [konveyor/editor-extensions@${{ needs.build.outputs.upstream_sha_short }}](https://github.com/konveyor/editor-extensions/commit/${{ needs.build.outputs.upstream_sha }})
            - **Tag**: ${{ github.ref_name }}

            ### Extensions Included
            - `mta-vscode-extension` - Core extension
            - `mta-java` - Java language support
            - `mta-javascript` - JavaScript/TypeScript language support

            ### Installation

            Download the `.vsix` files and install in VS Code:

            ```bash
            code --install-extension mta-vscode-extension-${{ needs.build.outputs.mta_version }}.vsix
            code --install-extension mta-java-${{ needs.build.outputs.mta_version }}.vsix
            code --install-extension mta-javascript-${{ needs.build.outputs.mta_version }}.vsix
            ```

            Or use the VS Code Extensions view: **Extensions → ⋯ → Install from VSIX...**

            ### Links
            - [MTA Product Page](https://developers.redhat.com/products/mta/overview)
            - [Documentation](https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/)
            - [Upstream Konveyor](https://github.com/konveyor/editor-extensions)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "## ✅ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.build.outputs.mta_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: [${{ github.ref_name }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
